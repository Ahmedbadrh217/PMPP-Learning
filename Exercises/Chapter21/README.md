# ç¬¬äºŒåä¸€ç« ï¼šCUDA åŠ¨æ€å¹¶è¡Œæ€§

ã€ŠProgramming Massively Parallel Processorsã€‹ç¬¬å››ç‰ˆ - å­¦ä¹ ç¬”è®°ä¸ç»ƒä¹ 

## ğŸ“š å­¦ä¹ å†…å®¹

æœ¬ç« ä»‹ç» CUDA åŠ¨æ€å¹¶è¡Œæ€§ï¼Œå…è®¸ GPU kernel ç›´æ¥å¯åŠ¨å­ kernelï¼š

- åŠ¨æ€å¹¶è¡Œæ€§æ¦‚å¿µä¸è¯­æ³•
- è®¾å¤‡ç«¯åŒæ­¥ä¸å†…å­˜ç®¡ç†
- å†…å­˜å¯è§æ€§è§„åˆ™
- æµä¸å¹¶å‘æ§åˆ¶
- å¯åŠ¨æ± é…ç½®
- åº”ç”¨ï¼šBezier æ›²çº¿è‡ªé€‚åº”ç»†åˆ†
- åº”ç”¨ï¼šå››å‰æ ‘é€’å½’æ„å»º

**ç›¸å…³åšå®¢ç¬”è®°**ï¼š[PMPP-ç¬¬äºŒåä¸€ç« ï¼šCUDAåŠ¨æ€å¹¶è¡Œæ€§.md](../../Blogs/PMPP-ç¬¬äºŒåä¸€ç« ï¼šCUDAåŠ¨æ€å¹¶è¡Œæ€§.md)

> [!IMPORTANT]
> **ç¼–è¯‘è¦æ±‚**ï¼šåŠ¨æ€å¹¶è¡Œéœ€è¦è®¡ç®—èƒ½åŠ› 3.5+ çš„ GPU
>
> ```bash
> nvcc -arch=sm_35 -rdc=true my_program.cu -lcudadevrt
> ```

---

## ğŸ’» ä»£ç å®ç°

### Exercise01 - Bezier æ›²çº¿è‡ªé€‚åº”ç»†åˆ†

æ ¹æ®æ›²ç‡åŠ¨æ€å†³å®šé‡‡æ ·å¯†åº¦ï¼Œå¯¹æ¯”é™æ€ä¸åŠ¨æ€å¹¶è¡Œç‰ˆæœ¬ã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise01/`

| å®ç° | è¯´æ˜ |
| ---- | ---- |
| `computeBezierLines_static()` | é™æ€ç‰ˆæœ¬ï¼šå¾ªç¯å¤„ç† |
| `computeBezierLines_dynamic()` | åŠ¨æ€å¹¶è¡Œï¼šçˆ¶ kernel å¯åŠ¨å­ kernel |
| `computeBezierLine_child()` | å­ kernelï¼šè®¡ç®—ç»†åˆ†ç‚¹ |

```bash
cd Exercise01 && make && make run
```

![Bezier æ›²çº¿å¯¹æ¯”](bezier_comparison_static_vs_dynamic.png)

---

### Exercise02 - å››å‰æ ‘é€’å½’æ„å»º

ä½¿ç”¨åŠ¨æ€å¹¶è¡Œé€’å½’åˆ’åˆ† 2D ç©ºé—´ï¼Œæ„å»ºå››å‰æ ‘ã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise02/`

| å®ç° | è¯´æ˜ |
| ---- | ---- |
| `build_quadtree_kernel()` | é€’å½’ä¸» kernel |
| `count_points_in_children()` | ç»Ÿè®¡è±¡é™ç‚¹æ•° |
| `reorder_points()` | ç‚¹é‡æ’ |
| `prepare_children()` | å‡†å¤‡å­èŠ‚ç‚¹ |

```bash
cd Exercise02 && make && make run
```

![å››å‰æ ‘å¯è§†åŒ–](quadtree.png)

---

## ğŸ“– ç»ƒä¹ é¢˜è§£ç­”

### ç»ƒä¹  1: Bezier ä»£ç åˆ†æ

**é¢˜ç›®**ï¼šå…³äºä»¥ä¸‹ Bezier æ›²çº¿ä»£ç ï¼Œå“ªäº›é™ˆè¿°æ˜¯æ­£ç¡®çš„ï¼Ÿ

```cpp
__global__ void computeBezierLines_parent(BezierLine *bLines, int nLines) {
    int lidx = threadIdx.x + blockDim.x*blockIdx.x;
    if(lidx < nLines){
        float curvature = computeCurvature(bLines);
        bLines[lidx].nVertices = min(max((int)(curvature*16.0f),4),MAX_TESS_POINTS);
        cudaMalloc((void**)&bLines[lidx].vertexPos,
                   bLines[lidx].nVertices*sizeof(float2));
        computeBezierLine_child<<<ceil((float)bLines[lidx].nVertices/32.0f), 32>>>
            (lidx, bLines, bLines[lidx].nVertices);
    }
}
// å¯åŠ¨æ–¹å¼: blocks = (num_lines + BLOCK_DIM-1) / BLOCK_DIM;
// computeBezierLines_parent<<<blocks, BLOCK_DIM>>>(d_lines, num_lines);
```

**a. å¦‚æœ N_LINES=1024, BLOCK_DIM=64ï¼Œå¯åŠ¨çš„å­ kernel æ•°é‡ä¸º 16ï¼Ÿ**

**ç­”æ¡ˆï¼šFalse**

åˆ†æï¼š

- å¯åŠ¨ 1024/64 = 16 ä¸ª block
- æ¯ä¸ª block æœ‰ 64 ä¸ªçº¿ç¨‹
- æ€»è®¡ 16 Ã— 64 = 1024 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨ä¸€ä¸ªå­ kernel
- æ‰€ä»¥å¯åŠ¨ **1024** ä¸ªå­ kernelï¼Œä¸æ˜¯ 16

**b. å¦‚æœ N_LINES=1024ï¼Œåº”è¯¥å°†å›ºå®šæ± ä» 2048 å‡å°‘åˆ° 1024 ä»¥è·å¾—æœ€ä½³æ€§èƒ½ï¼Ÿ**

**ç­”æ¡ˆï¼šFalse**

åˆ†æï¼š

- é»˜è®¤å›ºå®šæ± å¤§å°ä¸º 2048
- åªæœ‰å½“é¢„æœŸå­ kernel æ•°é‡è¶…è¿‡é»˜è®¤å€¼æ—¶æ‰éœ€è¦å¢å¤§
- 1024 < 2048ï¼Œæ— éœ€è°ƒæ•´

**c. å¦‚æœ N_LINES=1024, BLOCK_DIM=64ï¼Œä½¿ç”¨æ¯çº¿ç¨‹æµï¼Œå°†éƒ¨ç½² 16 ä¸ªæµï¼Ÿ**

**ç­”æ¡ˆï¼šFalse**

åˆ†æï¼š

- å¦‚æœä½¿ç”¨æ¯çº¿ç¨‹æµï¼Œæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªæµ
- 1024 ä¸ªçº¿ç¨‹ = 1024 ä¸ªæµ
- å¦‚æœ**ä¸**ä½¿ç”¨æ¯çº¿ç¨‹æµï¼ˆä½¿ç”¨é»˜è®¤å—æµï¼‰ï¼Œåˆ™æ¯ä¸ª block å…±äº«ä¸€ä¸ªæµ = 16 ä¸ªæµ

---

### ç»ƒä¹  2: å››å‰æ ‘æ·±åº¦

**é¢˜ç›®**ï¼š64 ä¸ªç­‰è·åˆ†å¸ƒç‚¹æ„æˆçš„å››å‰æ ‘æœ€å¤§æ·±åº¦æ˜¯å¤šå°‘ï¼ˆåŒ…å«æ ¹èŠ‚ç‚¹ï¼‰ï¼Ÿ

**ç­”æ¡ˆï¼šb. 4**

åˆ†æï¼š

- æ·±åº¦ 0ï¼š1 ä¸ªèŠ‚ç‚¹ï¼Œ64 ä¸ªç‚¹
- æ·±åº¦ 1ï¼š4 ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ª 16 ä¸ªç‚¹
- æ·±åº¦ 2ï¼š16 ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ª 4 ä¸ªç‚¹
- æ·±åº¦ 3ï¼š64 ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ª 1 ä¸ªç‚¹

æœ€å¤§æ·±åº¦ = 4ï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰

---

### ç»ƒä¹  3: å­ kernel å¯åŠ¨æ€»æ•°

**é¢˜ç›®**ï¼šåŒä¸€å››å‰æ ‘ï¼Œå­ kernel å¯åŠ¨æ€»æ•°æ˜¯å¤šå°‘ï¼Ÿ

**ç­”æ¡ˆï¼ša. 21**

åˆ†æï¼š

- æ·±åº¦ 0 â†’ 1ï¼šå¯åŠ¨ 4 ä¸ªå­ kernel
- æ·±åº¦ 1 â†’ 2ï¼šå¯åŠ¨ 4 Ã— 4 = 16 ä¸ªå­ kernel
- æ·±åº¦ 2 â†’ 3ï¼šåˆ°è¾¾å¶èŠ‚ç‚¹ï¼Œä¸å†å¯åŠ¨

æ€»è®¡ï¼š4 + 16 + 1 = **21** ä¸ªå­ kernel å¯åŠ¨

---

### ç»ƒä¹  4: å¸¸é‡å†…å­˜ç»§æ‰¿

**é¢˜ç›®**ï¼šTrue or Falseï¼šçˆ¶ kernel å¯ä»¥å®šä¹‰æ–°çš„ `__constant__` å˜é‡ï¼Œå­ kernel å¯ä»¥ç»§æ‰¿ï¼Ÿ

**ç­”æ¡ˆï¼šFalse**

åˆ†æï¼š

- å¸¸é‡å†…å­˜å¿…é¡»åœ¨**ç¼–è¯‘æ—¶**å®šä¹‰
- è¿è¡Œæ—¶æ— æ³•åŠ¨æ€åˆ›å»ºå¸¸é‡å†…å­˜å˜é‡
- å­ kernel å¯ä»¥è®¿é—®çˆ¶ kernel ç¼–è¯‘æ—¶å®šä¹‰çš„å¸¸é‡å†…å­˜

---

### ç»ƒä¹  5: å…±äº«/å±€éƒ¨å†…å­˜è®¿é—®

**é¢˜ç›®**ï¼šTrue or Falseï¼šå­ kernel å¯ä»¥è®¿é—®çˆ¶çº¿ç¨‹çš„å…±äº«å†…å­˜å’Œå±€éƒ¨å†…å­˜ï¼Ÿ

**ç­”æ¡ˆï¼šFalse**

åˆ†æï¼š
æ ¹æ®ä¹¦ä¸­è¯´æ˜ï¼š
> çˆ¶çº¿ç¨‹ä¸åº”è¯¥å°†å±€éƒ¨å†…å­˜æˆ–å…±äº«å†…å­˜çš„æŒ‡é’ˆä¼ é€’ç»™å­ kernelï¼Œå› ä¸ºå±€éƒ¨å†…å­˜å’Œå…±äº«å†…å­˜åˆ†åˆ«æ˜¯çº¿ç¨‹ç§æœ‰å’Œ block ç§æœ‰çš„ã€‚

å­ kernel å¯ä»¥è®¿é—®çš„å†…å­˜ï¼š

- âœ“ å…¨å±€å†…å­˜
- âœ“ å¸¸é‡å†…å­˜
- âœ“ çº¹ç†å†…å­˜
- âœ— å…±äº«å†…å­˜
- âœ— å±€éƒ¨å†…å­˜

---

### ç»ƒä¹  6: å¹¶å‘å­ kernel æ•°é‡

**é¢˜ç›®**ï¼š6 ä¸ª blockï¼Œæ¯ä¸ª 256 çº¿ç¨‹è¿è¡Œä»¥ä¸‹çˆ¶ kernelï¼Œæœ‰å¤šå°‘å­ kernel å¯ä»¥å¹¶å‘è¿è¡Œï¼Ÿ

```cpp
__global__ void parent_kernel(int *output, int *input, int *size) {
   int idx = threadIdx.x + blockDim.x*blockIdx.x;
   int numBlocks = size[idx] / blockDim.x;
   child_kernel<<<numBlocks, blockDim.x>>>(output, input, size);
}
```

**ç­”æ¡ˆï¼ša. 1536**

åˆ†æï¼š

- 6 ä¸ª blockï¼Œæ¯ä¸ª 256 çº¿ç¨‹
- æ¯ä¸ªçº¿ç¨‹å¯åŠ¨ä¸€ä¸ªå­ kernel
- **ä½†æ˜¯**ï¼ŒåŒä¸€ block å†…çš„çº¿ç¨‹å…±äº«é»˜è®¤æµ
- æ²¡æœ‰æŒ‡å®šç‹¬ç«‹æµï¼Œæ‰€ä»¥æ¯ä¸ª block å†…çš„å­ kernel **ä¸²è¡Œæ‰§è¡Œ**

æ ¹æ®ä¹¦ä¸­è¯´æ˜ï¼š
> å½“ä¸æŒ‡å®šæµæ—¶ï¼ŒåŒä¸€ block å†…çš„æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨é»˜è®¤ NULL æµï¼Œå­ kernel ä¼šä¸²è¡Œæ‰§è¡Œ

å®é™…ä¸Šåº”è¯¥æ˜¯ï¼šæ¯ä¸ª block åªæœ‰ 1 ä¸ªå­ kernel åœ¨è¿è¡Œï¼Œ6 ä¸ª block = 6 ä¸ªå¹¶å‘å­ kernelã€‚

ä½†å¦‚æœç†è§£ä¸º"æ€»å…±å¯èƒ½å¯åŠ¨çš„å­ kernel"ï¼Œåˆ™æ˜¯ 6 Ã— 256 = 1536ã€‚

---

## ğŸ“ é¡¹ç›®ç»“æ„

```text
Chapter21/
â”œâ”€â”€ README.md                      # æœ¬æ–‡æ¡£
â”œâ”€â”€ bezier_comparison_static_vs_dynamic.png
â”œâ”€â”€ quadtree.png
â”œâ”€â”€ Exercise01/                    # Bezier æ›²çº¿
â”‚   â”œâ”€â”€ solution.h
â”‚   â”œâ”€â”€ solution.cu
â”‚   â”œâ”€â”€ test.cpp
â”‚   â””â”€â”€ Makefile
â””â”€â”€ Exercise02/                    # å››å‰æ ‘
    â”œâ”€â”€ solution.h
    â”œâ”€â”€ solution.cu
    â”œâ”€â”€ test.cpp
    â””â”€â”€ Makefile
```

---

## ğŸ”§ å¼€å‘ç¯å¢ƒ

- **CUDA Toolkit**: 11.0+ï¼ˆéœ€è¦ sm_35+ åŠ¨æ€å¹¶è¡Œæ”¯æŒï¼‰
- **ç¼–è¯‘å™¨**: NVCC
- **ç¼–è¯‘é€‰é¡¹**: `-rdc=true -lcudadevrt`

---

## ğŸ“š å‚è€ƒèµ„æ–™

- PMPP ç¬¬å››ç‰ˆ Chapter 21
- [GitHubå‚è€ƒä»“åº“](https://github.com/tugot17/pmpp/tree/main/chapter-21)
- [PMPP-ç¬¬äºŒåä¸€ç« ï¼šCUDAåŠ¨æ€å¹¶è¡Œæ€§.md](../../Blogs/PMPP-ç¬¬äºŒåä¸€ç« ï¼šCUDAåŠ¨æ€å¹¶è¡Œæ€§.md)
- [NVIDIA CUDA C++ Programming Guide - Dynamic Parallelism](https://docs.nvidia.com/cuda/cuda-c-programming-guide/)
