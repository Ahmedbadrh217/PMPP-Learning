# ç¬¬ä¸ƒç« ï¼šå·ç§¯

ã€ŠProgramming Massively Parallel Processorsã€‹ç¬¬å››ç‰ˆ - å­¦ä¹ ç¬”è®°ä¸ç»ƒä¹ 

## ğŸ“š å­¦ä¹ å†…å®¹

æœ¬ç« ç³»ç»Ÿæ¢³ç†å·ç§¯è¿ç®—åŠå…¶ CUDA ä¼˜åŒ–æŠ€æœ¯ï¼š

- 1D/2D/3D å·ç§¯è¿ç®—åŸç†
- Ghost cellsï¼ˆè¾¹ç•Œå¤„ç†ï¼‰
- å¸¸é‡å†…å­˜ï¼ˆConstant Memoryï¼‰
- Tiled å·ç§¯ä¸å…±äº«å†…å­˜
- L2 ç¼“å­˜åˆ©ç”¨

**ç›¸å…³åšå®¢ç¬”è®°**ï¼š[PMPP-ç¬¬ä¸ƒç« ï¼šå·ç§¯.md](../../Blogs/PMPP-ç¬¬ä¸ƒç« ï¼šå·ç§¯.md)

---

## ğŸ’» ä»£ç å®ç°

### Exercise01 - 2Då·ç§¯åŸºç¡€

å®ç°æœ´ç´ 2Då·ç§¯å’Œä½¿ç”¨å¸¸é‡å†…å­˜çš„2Då·ç§¯ï¼ˆå¯¹åº”å›¾7.7å’Œå›¾7.9ï¼‰ã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise01/`

**æ ¸å¿ƒå®ç°**ï¼š

| Kernel | ç‰¹ç‚¹ |
| ------ | ---- |
| `conv2d_basic_kernel` | æœ´ç´ å®ç°ï¼Œæ»¤æ³¢å™¨ä»å…¨å±€å†…å­˜è¯»å– |
| `conv2d_const_memory_kernel` | æ»¤æ³¢å™¨å­˜å‚¨åœ¨å¸¸é‡å†…å­˜ï¼Œç¼“å­˜å¹¿æ’­ |

```cuda
// å¸¸é‡å†…å­˜ç‰ˆæœ¬æ ¸å¿ƒä»£ç 
__constant__ float d_F[MAX_FILTER_SIZE];

__global__ void conv2d_const_memory_kernel(float* N, float* P, int r, int height, int width) {
    int outRow = blockIdx.y * blockDim.y + threadIdx.y;
    int outCol = blockIdx.x * blockDim.x + threadIdx.x;
    
    if (outRow < height && outCol < width) {
        float Pvalue = 0.0f;
        for (int fRow = 0; fRow < 2*r+1; ++fRow) {
            for (int fCol = 0; fCol < 2*r+1; ++fCol) {
                int inRow = outRow - r + fRow;
                int inCol = outCol - r + fCol;
                if (inRow >= 0 && inRow < height && inCol >= 0 && inCol < width) {
                    Pvalue += N[inRow * width + inCol] * d_F[fRow * (2*r+1) + fCol];
                }
            }
        }
        P[outRow * width + outCol] = Pvalue;
    }
}
```

#### è¿è¡Œ Exercise01

```bash
cd Exercise01
make
make run
```

---

### Exercise02 - Tiled 2Då·ç§¯

å®ç° Tiled 2Då·ç§¯ï¼Œä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–ï¼ˆå¯¹åº”å›¾7.12å’Œå›¾7.15ï¼‰ã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise02/`

**æ ¸å¿ƒå®ç°**ï¼š

| Kernel | ç‰¹ç‚¹ |
| ------ | ---- |
| `conv2d_tiled_kernel` | å®Œæ•´ input tile åŠ è½½åˆ°å…±äº«å†…å­˜ |
| `conv2d_tiled_cached_kernel` | è¾“å‡º tile ç”¨å…±äº«å†…å­˜ï¼Œè¾¹ç•Œä¾èµ–L2ç¼“å­˜ |

```cuda
// Tiled å·ç§¯æ ¸å¿ƒä»£ç 
#define IN_TILE_SIZE 32
#define OUT_TILE_SIZE (IN_TILE_SIZE - 2 * FILTER_RADIUS)

__global__ void conv2d_tiled_kernel(float* N, float* P, int r, int height, int width) {
    __shared__ float N_s[IN_TILE_SIZE][IN_TILE_SIZE];
    
    int row = blockIdx.y * OUT_TILE_SIZE + threadIdx.y - FILTER_RADIUS;
    int col = blockIdx.x * OUT_TILE_SIZE + threadIdx.x - FILTER_RADIUS;
    
    // åä½œåŠ è½½
    if (row >= 0 && row < height && col >= 0 && col < width) {
        N_s[threadIdx.y][threadIdx.x] = N[row * width + col];
    } else {
        N_s[threadIdx.y][threadIdx.x] = 0.0f;
    }
    __syncthreads();
    
    // åªæœ‰è¾“å‡º tile å†…çš„çº¿ç¨‹è®¡ç®—
    int tileRow = threadIdx.y - FILTER_RADIUS;
    int tileCol = threadIdx.x - FILTER_RADIUS;
    if (tileRow >= 0 && tileRow < OUT_TILE_SIZE && 
        tileCol >= 0 && tileCol < OUT_TILE_SIZE) {
        // ä»å…±äº«å†…å­˜è¯»å–è®¡ç®—
    }
}
```

#### è¿è¡Œ Exercise02

```bash
cd Exercise02
make
make run
```

---

### Exercise03 - 3Då·ç§¯ï¼ˆç»ƒä¹ 8-10ï¼‰

å®ç°ç»ƒä¹ 8ã€9ã€10è¦æ±‚çš„3Då·ç§¯ kernelã€‚

**ä»£ç ä½ç½®**ï¼š`Exercise03/`

| ç»ƒä¹  | å®ç° | è¯´æ˜ |
| ---- | ---- | ---- |
| ç»ƒä¹ 8 | `conv3d_basic_kernel` | å›¾7.7æ‰©å±•åˆ°3D |
| ç»ƒä¹ 9 | `conv3d_const_memory_kernel` | å›¾7.9æ‰©å±•åˆ°3D |
| ç»ƒä¹ 10 | `conv3d_tiled_kernel` | å›¾7.12æ‰©å±•åˆ°3D |

#### è¿è¡Œ Exercise03

```bash
cd Exercise03
make
make run
```

---

## ğŸ“– ç»ƒä¹ é¢˜è§£ç­”

### ç»ƒä¹  1

**é¢˜ç›®ï¼š** è®¡ç®—å›¾7.3ä¸­çš„ P[0] å€¼ã€‚

**è§£ç­”ï¼š**

```
x = [0, 0, 8, 2, 5]
f = [1, 3, 5, 3, 1]
P[0] = 0Ã—1 + 0Ã—3 + 8Ã—5 + 2Ã—3 + 5Ã—1 = 0 + 0 + 40 + 6 + 5 = 51
```

---

### ç»ƒä¹  2

**é¢˜ç›®ï¼š** å¯¹æ•°ç»„ N = {4,1,3,2,3} ä½¿ç”¨æ»¤æ³¢å™¨ F = {2,1,4} è¿›è¡Œ1Då·ç§¯ï¼Œæ±‚è¾“å‡ºæ•°ç»„ã€‚

**è§£ç­”ï¼š**

æ·»åŠ  ghost cellsï¼š`N_padded = [0, 4, 1, 3, 2, 3, 0]`

```
P[0] = [0, 4, 1] Â· [2, 1, 4] = 0 + 4 + 4 = 8
P[1] = [4, 1, 3] Â· [2, 1, 4] = 8 + 1 + 12 = 21
P[2] = [1, 3, 2] Â· [2, 1, 4] = 2 + 3 + 8 = 13
P[3] = [3, 2, 3] Â· [2, 1, 4] = 6 + 2 + 12 = 20
P[4] = [2, 3, 0] Â· [2, 1, 4] = 4 + 3 + 0 = 7

P = [8, 21, 13, 20, 7]
```

---

### ç»ƒä¹  3

**é¢˜ç›®ï¼š** ä»¥ä¸‹1Då·ç§¯æ»¤æ³¢å™¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**a. [0 1 0]**

**è§£ç­”ï¼š** æ’ç­‰æ»¤æ³¢å™¨ã€‚è¾“å‡ºç­‰äºè¾“å…¥ã€‚

**b. [0 0 1]**

**è§£ç­”ï¼š** å³ç§»æ»¤æ³¢å™¨ã€‚å°†ä¿¡å·å‘å³ç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚

**c. [1 0 0]**

**è§£ç­”ï¼š** å·¦ç§»æ»¤æ³¢å™¨ã€‚å°†ä¿¡å·å‘å·¦ç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚

**d. [-1/2 0 1/2]**

**è§£ç­”ï¼š** è¾¹ç¼˜æ£€æµ‹ï¼ˆå·®åˆ†ï¼‰æ»¤æ³¢å™¨ã€‚æ£€æµ‹ä¿¡å·çš„å˜åŒ–ç‡ï¼Œç›¸é‚»å€¼ç›¸ä¼¼åˆ™è¾“å‡ºè¶‹è¿‘äº0ã€‚

**e. [1/3 1/3 1/3]**

**è§£ç­”ï¼š** å‡å€¼æ»¤æ³¢å™¨ã€‚å¯¹ä¿¡å·è¿›è¡Œå¹³æ»‘å¤„ç†ï¼Œå–ç›¸é‚»ä¸‰ä¸ªå€¼çš„å¹³å‡ã€‚

---

### ç»ƒä¹  4

**é¢˜ç›®ï¼š** å¯¹å¤§å°ä¸º N çš„æ•°ç»„ä½¿ç”¨å¤§å°ä¸º M çš„æ»¤æ³¢å™¨è¿›è¡Œ1Då·ç§¯ï¼š

**a. æ€»å…±æœ‰å¤šå°‘ ghost cellsï¼Ÿ**

**è§£ç­”ï¼š** æ»¤æ³¢å™¨åŠå¾„ `r = (M-1)/2`ï¼Œå·¦å³å„æœ‰ r ä¸ª ghost cellsï¼Œæ€»å…± **M-1** ä¸ªã€‚

**b. å¦‚æœ ghost cells ä¹Ÿè®¡ä¸ºä¹˜æ³•ï¼ˆä¹˜ä»¥0ï¼‰ï¼Œæ€»å…±æœ‰å¤šå°‘æ¬¡ä¹˜æ³•ï¼Ÿ**

**è§£ç­”ï¼š** æ¯ä¸ªè¾“å‡ºå…ƒç´ éœ€è¦ M æ¬¡ä¹˜æ³•ï¼Œå…± N ä¸ªè¾“å‡ºï¼Œæ€»å…± **N Ã— M** æ¬¡ä¹˜æ³•ã€‚

**c. å¦‚æœ ghost cells ä¸è®¡ä¸ºä¹˜æ³•ï¼Œæ€»å…±æœ‰å¤šå°‘æ¬¡ä¹˜æ³•ï¼Ÿ**

**è§£ç­”ï¼š**

- å®Œæ•´ä¹˜æ³•ï¼šN Ã— M
- è¾¹ç•Œå¤„å‡å°‘çš„ä¹˜æ³•ï¼š`r + (r-1) + ... + 1 = r(r+1)/2`ï¼ˆå·¦å³å„ä¸€æ¬¡ï¼‰
- æ€»è®¡ï¼š**N Ã— M - r(r+1)** æ¬¡ä¹˜æ³•

---

### ç»ƒä¹  5

**é¢˜ç›®ï¼š** å¯¹ N Ã— N çŸ©é˜µä½¿ç”¨ M Ã— M æ»¤æ³¢å™¨è¿›è¡Œ2Då·ç§¯ï¼š

**a. æ€»å…±æœ‰å¤šå°‘ ghost cellsï¼Ÿ**

**è§£ç­”ï¼š**

- å››æ¡è¾¹ï¼š`4 Ã— N Ã— r`
- å››ä¸ªè§’ï¼š`4 Ã— rÂ²`
- æ€»è®¡ï¼š**4r Ã— (N + r)** ä¸ª ghost cells

**b. å¦‚æœ ghost cells ä¹Ÿè®¡ä¸ºä¹˜æ³•ï¼Œæ€»å…±æœ‰å¤šå°‘æ¬¡ä¹˜æ³•ï¼Ÿ**

**è§£ç­”ï¼š** **NÂ² Ã— MÂ²** æ¬¡ä¹˜æ³•

**c. å¦‚æœ ghost cells ä¸è®¡ä¸ºä¹˜æ³•ï¼Œæ€»å…±æœ‰å¤šå°‘æ¬¡ä¹˜æ³•ï¼Ÿ**

**è§£ç­”ï¼š**

```
NÂ² Ã— MÂ² - 2 Ã— N Ã— r Ã— (r+1) - 4 Ã— [r(r+1)/2]Â²
```

---

### ç»ƒä¹  6

**é¢˜ç›®ï¼š** å¯¹ Nâ‚ Ã— Nâ‚‚ çŸ©é˜µä½¿ç”¨ Mâ‚ Ã— Mâ‚‚ æ»¤æ³¢å™¨è¿›è¡Œ2Då·ç§¯ï¼š

è®¾ `râ‚ = (Mâ‚-1)/2`ï¼Œ`râ‚‚ = (Mâ‚‚-1)/2`

**a. æ€»å…±æœ‰å¤šå°‘ ghost cellsï¼Ÿ**

**è§£ç­”ï¼š** **2 Ã— (Nâ‚ Ã— râ‚‚ + Nâ‚‚ Ã— râ‚) + 4 Ã— râ‚ Ã— râ‚‚**

**b. å¦‚æœ ghost cells ä¹Ÿè®¡ä¸ºä¹˜æ³•ï¼Œæ€»å…±æœ‰å¤šå°‘æ¬¡ä¹˜æ³•ï¼Ÿ**

**è§£ç­”ï¼š** **Nâ‚ Ã— Nâ‚‚ Ã— Mâ‚ Ã— Mâ‚‚**

**c. å¦‚æœ ghost cells ä¸è®¡ä¸ºä¹˜æ³•ï¼Œæ€»å…±æœ‰å¤šå°‘æ¬¡ä¹˜æ³•ï¼Ÿ**

**è§£ç­”ï¼š**

```
Nâ‚ Ã— Nâ‚‚ Ã— Mâ‚ Ã— Mâ‚‚ - Nâ‚ Ã— râ‚‚ Ã— (râ‚‚+1) - Nâ‚‚ Ã— râ‚ Ã— (râ‚+1) - [râ‚(râ‚+1)/2] Ã— [râ‚‚(râ‚‚+1)/2]
```

---

### ç»ƒä¹  7

**é¢˜ç›®ï¼š** è€ƒè™‘ä½¿ç”¨å›¾7.12çš„ kernel å¯¹ N Ã— N æ•°ç»„è¿›è¡Œ Tiled å·ç§¯ï¼Œæ»¤æ³¢å™¨ M Ã— Mï¼Œè¾“å‡º tile T Ã— Tï¼š

**a. éœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹å—ï¼Ÿ**

**è§£ç­”ï¼š** `[(N + T - 1)/T] Ã— [(N + T - 1)/T]` ä¸ªçº¿ç¨‹å—

**b. æ¯ä¸ªå—éœ€è¦å¤šå°‘çº¿ç¨‹ï¼Ÿ**

**è§£ç­”ï¼š** è¾“å…¥ tile å¤§å°ä¸º `T + M - 1`ï¼Œæ¯å— **(T + M - 1)Â² ä¸ªçº¿ç¨‹**

**c. æ¯ä¸ªå—éœ€è¦å¤šå°‘å…±äº«å†…å­˜ï¼Ÿ**

**è§£ç­”ï¼š** **(T + M - 1)Â² Ã— 4 å­—èŠ‚**ï¼ˆfloatç±»å‹ï¼‰

**d. å¦‚æœä½¿ç”¨å›¾7.15çš„ kernelï¼Œä¸Šè¿°é—®é¢˜çš„ç­”æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ**

**è§£ç­”ï¼š**

- çº¿ç¨‹å—æ•°ï¼šç›¸åŒï¼Œ`[(N + T - 1)/T]Â²`
- æ¯å—çº¿ç¨‹æ•°ï¼š**TÂ² ä¸ªçº¿ç¨‹**
- å…±äº«å†…å­˜ï¼š**TÂ² Ã— 4 å­—èŠ‚**

---

### ç»ƒä¹  8

**é¢˜ç›®ï¼š** å°†å›¾7.7çš„2D kernel ä¿®æ”¹ä¸º3Då·ç§¯ã€‚

**è§£ç­”ï¼š** è§ `Exercise03/solution.cu` ä¸­çš„ `conv3d_basic_kernel` å®ç°ã€‚

å…³é”®ä¿®æ”¹ï¼š

- æ·»åŠ  z ç»´åº¦çš„å¾ªç¯å’Œåæ ‡è®¡ç®—
- 3D ç´¢å¼•ï¼š`index = z * width * height + y * width + x`

---

### ç»ƒä¹  9

**é¢˜ç›®ï¼š** å°†å›¾7.9çš„2D kernel ä¿®æ”¹ä¸º3Då·ç§¯ã€‚

**è§£ç­”ï¼š** è§ `Exercise03/solution.cu` ä¸­çš„ `conv3d_const_memory_kernel` å®ç°ã€‚

å…³é”®ä¿®æ”¹ï¼š

- ä½¿ç”¨3Då¸¸é‡å†…å­˜æ•°ç»„
- 3D æ»¤æ³¢å™¨ç´¢å¼•è®¡ç®—

---

### ç»ƒä¹  10

**é¢˜ç›®ï¼š** å°†å›¾7.12çš„ Tiled 2D kernel ä¿®æ”¹ä¸º3Då·ç§¯ã€‚

**è§£ç­”ï¼š** è§ `Exercise03/solution.cu` ä¸­çš„ `conv3d_tiled_kernel` å®ç°ã€‚

å…³é”®ä¿®æ”¹ï¼š

- 3D å…±äº«å†…å­˜ï¼š`__shared__ float N_s[DIM][DIM][DIM]`
- 3D çº¿ç¨‹å—å’Œç½‘æ ¼é…ç½®
- æ³¨æ„ï¼š3D å…±äº«å†…å­˜éœ€æ±‚è¾ƒå¤§ï¼Œéœ€è¦å‡å° tile å°ºå¯¸

---

## ğŸ”§ å¼€å‘ç¯å¢ƒ

- **CUDA Toolkit**: 11.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **ç¼–è¯‘å™¨**: GCC 7.5+ / Visual Studio 2019+ + NVCC
- **GPU**: æ”¯æŒ CUDA çš„ NVIDIA æ˜¾å¡ï¼ˆè®¡ç®—èƒ½åŠ› 3.5+ï¼‰

## ğŸ’¡ å­¦ä¹ å»ºè®®

1. **ç†è§£å·ç§¯è¿ç®—**ï¼šå…ˆæ‰‹ç®—å°ä¾‹å­ç†è§£åŸç†
2. **è¾¹ç•Œå¤„ç†**ï¼šGhost cells çš„æ¦‚å¿µå¾ˆé‡è¦
3. **å¸¸é‡å†…å­˜**ï¼šé€‚åˆæ‰€æœ‰çº¿ç¨‹è®¿é—®ç›¸åŒæ•°æ®çš„åœºæ™¯
4. **Tiled è®¾è®¡**ï¼šæƒè¡¡è¾“å…¥è¾“å‡º tile å¤§å°å…³ç³»
5. **3D æ‰©å±•**ï¼šæ³¨æ„å…±äº«å†…å­˜å’Œçº¿ç¨‹æ•°é™åˆ¶

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œç»§ç»­å­¦ä¹ ï¼š

- ç¬¬å…«ç« ï¼šæ¨¡æ¿
- ç¬¬ä¹ç« ï¼šå¹¶è¡Œç›´æ–¹å›¾
- ç¬¬åç« ï¼šå½’çº¦

---

**å­¦ä¹ æ„‰å¿«ï¼** ğŸ“
